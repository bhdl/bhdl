{
  "id": "CPFGfA94kr88",
  "parentId": "CPtgV36e4DrU",
  "index": 12,
  "content": "\"(define (atom->fp-sexp atom x y a ID Hpin=>net Hnet=>index)\\n  \\\"Generate FP raw kicad sexp.\\\"\\n  (match-let ([pinhash (Atom-pinhash atom)])\\n    (match-let* ([fp (atom->fp atom)]\\n                 [(text-spec tx ty) (first (footprint-texts fp))]\\n                 [pad=>altstr (Atom->Hpad=>altstr atom)])\\n      `(module ,ID\\n         ;; FIXME I might want to place some atoms at B.Cu\\n         (layer F.Cu)\\n         (tedit 0) (tstamp 0)\\n               ;; CAUTION placement\\n               ;; FIXME scale\\n               ;;\\n               ;; FIXME however, this is centered location, but kicad seems to\\n               ;; expect top-left corner. But this still does not match exactly.\\n               (at ,x ,y ,(* (/ a pi) 180))\\n               (path placeholder)\\n               (fp_text reference\\n                        ;; this reference is required for Spectra export of\\n                        ;; KiCAD. But this UUID is too long for this purpose\\n                        ;;\\n                        ;; Add attrs, this might be too large\\n;;                         ,(if (empty? (ICAtom-attrs atom))\\n;;                              ID\\n;;                              (~a ID (ICAtom-attrs atom)))\\n                        ,ID\\n                        ;; FIXME it should be a little off? This should be different for different Units. Maybe place on top.                        \\n                        (at ,tx ,ty 0) (layer F.SilkS)\\n                        (effects (font (size 1.524 1.524) (thickness 0.3048))))\\n               ,@(for/list ([line (footprint-lines fp)])\\n                   (match line\\n                     [(line-spec x1 y1 x2 y2 width)\\n                      `(fp_line (start ,x1 ,y1) (end ,x2 ,y2)\\n                                (layer F.SilkS) (width ,width))]))\\n               ,@(for/list ([pad (filter\\n                                  ;; filter out mounting hole dummy pads\\n                                  (lambda (x)\\n                                    (not (equal? 'dummy (pad-spec-name x))))\\n                                  (append (footprint-pads fp)\\n                                         ;; FIXME kicad might use \\\"hole\\\" instead of pad\\n                                         (or (footprint-holes fp) '())))])\\n                   (match pad\\n                     [(pad-spec name x y pa mounting-type shape (list s1 s2) dsize layer)\\n                      ;; FIXME the fp dimension and the location seems to be in\\n                      ;; different units\\n                      `(pad ,name ,(case mounting-type\\n                                         ;; FIXME special handle for np_thru_hole\\n                                     [(thru_hole np_thru_hole) 'thru_hole]\\n                                     [(smd) 'smd]\\n                                     [else (error \\\"Unsupported mounting type:\\\"\\n                                                  mounting-type)])\\n                            ,shape (at ,x ,y ,(+ pa (* (/ a pi) 180)))\\n                            (size ,s1 ,s2)\\n                            ;; FIXME optional drill\\n                            ,@(case mounting-type\\n                                [(thru_hole np_thru_hole) `((drill ,@dsize)\\n                                               (layers *.Cu *.Mask))]\\n                                    ;; \\n                                [(smd) `((layers ,@(case layer\\n                                                        [(top) '(F.Cu F.Paste F.Mask)]\\n                                                        [(bottom) '(B.Cu B.Paste B.Mask)]\\n                                                        [else (warn \\\"smd must have either layer top or bottom, but got\\\" layer)\\n                                                              '(F.Cu F.Paste F.Mask)])\\n                                                 ;; FIXME should I have *.Mask layers at all?\\n                                                 ;; Or maybe KiCAD is clever enough to put only the outline as masked?\\n                                                 ;; Looks like NO, the mask is covering the whole pads.\\n                                                 ;;\\n                                                 ;; F.Mask\\n                                                 ))]\\n                                [else (error \\\"Unsupported mounting type:\\\"\\n                                             mounting-type)])\\n                            ;; FIXME HEBI layers\\n                            \\n                            ,@(let ([name (string->symbol (~a \\\"fp-\\\" name))])\\n                                (if (and (hash-has-key? pinhash name)\\n                                         (hash-has-key? Hpin=>net\\n                                                        (hash-ref pinhash name)))\\n                                    (let ([index (hash-ref\\n                                                  Hnet=>index\\n                                                  (hash-ref Hpin=>net\\n                                                            (hash-ref pinhash name)))])\\n                                      `((net ,index\\n                                             ,(number->string index))))\\n                                    null)))]))\\n               ;; pad names\\n               ,@(for/list ([pad (append (footprint-pads fp)\\n                                         ;; FIXME kicad might use \\\"hole\\\" instead of pad\\n                                         (or (footprint-holes fp) '()))])\\n                           (match pad\\n                                  [(pad-spec name x y pa mounting-type shape (list s1 s2) dsize layer)\\n                                   ;; TODO get the reasonable pad name(s)\\n                                   `(fp_text user ,(hash-ref pad=>altstr (~a name))\\n                                             ;; according to the pad shape, rotate the text accordingly\\n                                             ,(if (and (> s1 s2) (= pa 0))\\n                                                  `(at ,x ,y)\\n                                                  `(at ,x ,y 90))\\n;;                                              (at ,x ,y) \\n                                             (layer Eco1.User)\\n                                             ;; TODO I should make the font size configurable\\n                                             (effects \\n;;                                               (font (size 0.1 0.1) (thickness 0.01))\\n                                              (font (size 0.2 0.2) (thickness 0.05))\\n                                                      ))]))\\n               ;; FIXME placeholder\\n               ;; (net 21 /Leds/lrow3)\\n               ))))\"",
  "column": 1,
  "fold": false,
  "thundar": false,
  "utility": false,
  "name": "",
  "lang": "racket",
  "type": "CODE",
  "imports": "{}",
  "exports": "{\"atom->fp-sexp\":true}",
  "midports": "{}",
  "repoId": "102c7cad-cc6a-4ac2-b30c-d5e168c069bf"
}